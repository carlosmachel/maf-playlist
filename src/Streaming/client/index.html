<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat Streaming - Vue.js</title>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  <style>
    :root {
      --x-body-bg: #f8f9fa;
      --x-border-color: #dee2e6;
    }

    body {
      background-color: var(--x-body-bg);
      min-height: 100vh;
    }

    .chatpage-container {
      height: 100vh;
      max-height: 100vh;
    }

    .messages-container {
      flex: 1;
      overflow-y: auto;
      scrollbar-color: #6d6d6d transparent;
    }

    .message {
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .message.streaming .message-text::after {
      content: 'â–‹';
      animation: blink 1s infinite;
    }

    @keyframes blink {
      0%, 50% { opacity: 1; }
      51%, 100% { opacity: 0; }
    }

    .avatar {
      width: 2rem;
      height: 2rem;
    }

    .bg-gradient-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .bg-gradient-info {
      background: linear-gradient(135deg, #3b82f6 0%, #06b6d4 100%);
    }

    .chat-input {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(12px);
      border-radius: 18px;
      padding: 16px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08), 0 0 0 1px rgba(0, 0, 0, 0.05);
      transition: all 0.25s ease;
    }

    .chat-input:focus-within {
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12), 0 0 0 1px rgba(102, 126, 234, 0.3);
    }

    .chat-input-wrapper {
      position: sticky;
      bottom: 0;
      padding: 18px 16px;
      background: transparent;
    }

    .chat-input-container {
      max-width: 900px;
      margin: 0 auto;
    }

    .ai-reply-container {
      background-color: white;
    }

    .typing-indicator .spinner-grow {
      opacity: 0.5;
    }

    .token-badge {
      font-size: 0.75rem;
      padding: 4px 10px;
      border-radius: 20px;
      background: #f1f3f4;
      color: #5f6368;
    }

    .token-badge .value {
      font-weight: 600;
      color: #202124;
    }
  </style>
</head>
<body>
  <div id="app">
    <div class="chatpage-container d-flex flex-column">
      <!-- Header -->
      <div class="d-flex justify-content-between py-3 align-items-center px-3 border-bottom bg-white">
        <h2 class="h5 mb-0"><i class="bi bi-robot me-2"></i>Chat AI</h2>
        
        <!-- Mode Toggle -->
        <div class="d-flex gap-3 align-items-center">
          <div class="btn-group" role="group">
            <input type="radio" class="btn-check" name="mode" id="modeStreaming" value="streaming" v-model="mode">
            <label class="btn btn-outline-secondary btn-sm" for="modeStreaming">
              <i class="bi bi-broadcast me-1"></i>Streaming
            </label>
            <input type="radio" class="btn-check" name="mode" id="modeNormal" value="normal" v-model="mode">
            <label class="btn btn-outline-secondary btn-sm" for="modeNormal">
              <i class="bi bi-send me-1"></i>Normal
            </label>
          </div>
        </div>
      </div>


      <!-- Error Alert -->
      <div v-if="error" class="alert alert-danger m-3 mb-0 py-2" role="alert">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>{{ error }}
      </div>

      <!-- Empty State -->
      <div 
        v-if="messages.length === 0" 
        class="flex-grow-1 d-flex flex-column justify-content-center align-items-center text-center px-3"
      >
        <h2 class="fw-bold mb-2">ðŸ‘‹ Bem-vindo</h2>
        <p class="text-muted fs-6 mb-4">
          FaÃ§a uma pergunta para comeÃ§ar a conversa
        </p>

        <!-- Welcome Input -->
        <div class="w-100" style="max-width: 720px">
          <div class="chat-input">
            <textarea
              v-model="userInput"
              @keydown.enter.prevent="sendMessage"
              placeholder="Digite sua mensagem..."
              class="form-control border-0 bg-transparent shadow-none p-0"
              :disabled="isLoading"
              style="resize: none; min-height: 24px; max-height: 200px"
              rows="1"
            ></textarea>

            <div class="d-flex gap-2 mt-3 justify-content-end align-items-center">
              <button 
                @click="sendMessage"
                :disabled="!userInput.trim() || isLoading"
                class="btn btn-dark d-flex align-items-center justify-content-center"
                style="width: 40px; height: 40px; border-radius: 12px"
              >
                <span v-if="isLoading" class="spinner-border spinner-border-sm" role="status"></span>
                <i v-else class="bi bi-arrow-up"></i>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Messages Area -->
      <div 
        v-else
        class="flex-grow-1 overflow-auto p-3 messages-container"
        ref="messagesContainer"
      >
        <div class="container" style="max-width: 900px">
          <div class="d-flex flex-column gap-4">
            <div
              v-for="(message, index) in messages"
              :key="index"
              :class="['d-flex gap-3 message', message.role === 'user' ? 'justify-content-end' : 'flex-column', { streaming: message.isStreaming }]"
            >
              <!-- User message -->
              <template v-if="message.role === 'user'">
                <div class="d-flex gap-3 justify-content-end">
                  <div class="rounded-3 px-3 py-2 bg-dark text-white" style="max-width: 75%">
                    <p class="mb-0 message-text" style="white-space: pre-wrap; word-wrap: break-word">{{ message.content }}</p>
                  </div>
                  <div class="avatar rounded-circle bg-gradient-info d-flex align-items-center justify-content-center text-white flex-shrink-0">
                    <i class="bi bi-person-fill"></i>
                  </div>
                </div>
              </template>

              <!-- Assistant message -->
              <template v-else>
                <div class="d-flex gap-3">
                  <div class="avatar rounded-circle bg-gradient-primary d-flex align-items-center justify-content-center text-white flex-shrink-0">
                    <i class="bi bi-robot"></i>
                  </div>
                  <div class="ai-reply-container border shadow-sm rounded-3 px-3 py-2" style="max-width: 75%">
                    <p class="mb-0 message-text" style="white-space: pre-wrap; word-wrap: break-word">{{ message.content }}</p>
                  </div>
                </div>
                <!-- Token usage for this message -->
                <div v-if="message.tokenUsage && !message.isStreaming" class="d-flex gap-2 flex-wrap mt-2 ms-5 ps-3">
                  <span class="token-badge">
                    <i class="bi bi-arrow-right-short"></i> Input: <span class="value">{{ message.tokenUsage.inputTokens?.toLocaleString() || 0 }}</span>
                  </span>
                  <span class="token-badge">
                    <i class="bi bi-arrow-left-short"></i> Output: <span class="value">{{ message.tokenUsage.outputTokens?.toLocaleString() || 0 }}</span>
                  </span>
                  <span class="token-badge">
                    <i class="bi bi-calculator"></i> Total: <span class="value">{{ message.tokenUsage.totalTokens?.toLocaleString() || 0 }}</span>
                  </span>
                </div>
              </template>
            </div>

            <!-- Loading indicator -->
            <div v-if="isLoading && messages.length > 0 && !messages[messages.length - 1]?.isStreaming" class="d-flex gap-3">
              <div class="avatar rounded-circle bg-gradient-primary d-flex align-items-center justify-content-center text-white flex-shrink-0">
                <i class="bi bi-robot"></i>
              </div>
              <div class="ai-reply-container border shadow-sm rounded-3 px-3 py-2">
                <div class="typing-indicator d-flex gap-1">
                  <span class="spinner-grow spinner-grow-sm" role="status" style="width: 0.5rem; height: 0.5rem"></span>
                  <span class="spinner-grow spinner-grow-sm" role="status" style="width: 0.5rem; height: 0.5rem; animation-delay: 0.15s"></span>
                  <span class="spinner-grow spinner-grow-sm" role="status" style="width: 0.5rem; height: 0.5rem; animation-delay: 0.3s"></span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Input Area (when conversation started) -->
      <div v-if="messages.length > 0" class="chat-input-wrapper">
        <div class="chat-input-container">
          <div class="chat-input">
            <textarea
              v-model="userInput"
              @keydown.enter.prevent="sendMessage"
              placeholder="Responder..."
              class="form-control border-0 bg-transparent shadow-none p-0"
              :disabled="isLoading"
              style="resize: none; min-height: 24px; max-height: 200px"
              rows="1"
            ></textarea>

            <div class="d-flex gap-2 mt-3 justify-content-between align-items-center">
              <button 
                @click="clearChat"
                :disabled="isLoading"
                class="btn btn-sm btn-light rounded-circle d-flex align-items-center justify-content-center"
                style="width: 32px; height: 32px"
                title="Limpar conversa"
              >
                <i class="bi bi-trash"></i>
              </button>

              <button 
                @click="sendMessage"
                :disabled="!userInput.trim() || isLoading"
                class="btn btn-dark d-flex align-items-center justify-content-center"
                style="width: 40px; height: 40px; border-radius: 12px"
              >
                <span v-if="isLoading" class="spinner-border spinner-border-sm" role="status"></span>
                <i v-else class="bi bi-arrow-up"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const { createApp, ref, nextTick, watch } = Vue;

    createApp({
      setup() {
        const messages = ref([]);
        const userInput = ref('');
        const isLoading = ref(false);
        const mode = ref('streaming');
        const error = ref('');
        const messagesContainer = ref(null);

        const API_BASE_URL = 'http://localhost:5290';

        const scrollToBottom = async () => {
          await nextTick();
          if (messagesContainer.value) {
            messagesContainer.value.scrollTop = messagesContainer.value.scrollHeight;
          }
        };

        watch(messages, scrollToBottom, { deep: true });

        const sendMessage = async () => {
          const input = userInput.value.trim();
          if (!input || isLoading.value) return;

          error.value = '';
          
          messages.value.push({
            role: 'user',
            content: input
          });

          userInput.value = '';
          isLoading.value = true;

          try {
            if (mode.value === 'streaming') {
              await sendStreamingMessage(input);
            } else {
              await sendNormalMessage(input);
            }
          } catch (err) {
            console.error('Erro:', err);
            error.value = `Erro ao enviar mensagem: ${err.message}`;
          } finally {
            isLoading.value = false;
          }
        };

        const sendNormalMessage = async (input) => {
          const response = await fetch(`${API_BASE_URL}/run?userInput=${encodeURIComponent(input)}`, {
            method: 'POST'
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();
          
          messages.value.push({
            role: 'assistant',
            content: data.text,
            id: data.messageId,
            tokenUsage: {
              inputTokens: data.inputTokens,
              outputTokens: data.outputTokens,
              totalTokens: data.totalTokens
            }
          });
        };

        const sendStreamingMessage = async (input) => {
          const assistantMessage = {
            role: 'assistant',
            content: '',
            isStreaming: true,
            id: null,
            tokenUsage: null
          };
          messages.value.push(assistantMessage);
          const messageIndex = messages.value.length - 1;

          const response = await fetch(`${API_BASE_URL}/run-streaming?userInput=${encodeURIComponent(input)}`, {
            method: 'POST'
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const reader = response.body.getReader();
          const decoder = new TextDecoder();
          let buffer = '';

          while (true) {
            const { done, value } = await reader.read();
            
            if (done) {
              messages.value[messageIndex].isStreaming = false;
              break;
            }

            buffer += decoder.decode(value, { stream: true });
            
            const lines = buffer.split('\n');
            buffer = lines.pop() || '';

            for (const line of lines) {
              if (line.startsWith('data: ')) {
                try {
                  const jsonStr = line.slice(6);
                  const data = JSON.parse(jsonStr);
                  
                  if (data.eventName === 'TokenUsageResult') {
                    // Vincula o tokenUsage Ã  mensagem pelo messageId
                    messages.value[messageIndex].tokenUsage = {
                      inputTokens: data.content.inputTokens,
                      outputTokens: data.content.outputTokens,
                      totalTokens: data.content.totalTokens
                    };
                  }
                  else if (data.content && data.content.text) {
                    messages.value[messageIndex].content += data.content.text;
                    messages.value[messageIndex].id = data.content.id;
                  }
                  
                  if (data.content && data.content.isComplete) {
                    messages.value[messageIndex].isStreaming = false;
                  }
                } catch (e) {
                  console.warn('Erro ao parsear JSON:', e, line);
                }
              }
            }
          }
        };

        const clearChat = () => {
          messages.value = [];
          error.value = '';
        };

        return {
          messages,
          userInput,
          isLoading,
          mode,
          error,
          messagesContainer,
          sendMessage,
          clearChat
        };
      }
    }).mount('#app');
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
